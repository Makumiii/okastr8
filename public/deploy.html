<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deploy - okastr8</title>
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>ğŸš€ Deployments</h1>
            <span id="auth-status" class="auth-status">Checking...</span>
        </header>

        <a href="index.html" class="back-link">â† Back to Dashboard</a>

        <div class="form-grid">
            <!-- Trigger Deploy -->
            <div class="form-container full-width">
                <h3>ğŸš€ Trigger Deployment</h3>
                <form id="deploy-form">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" name="appName" placeholder="App name" required>
                        <input type="text" name="branch" placeholder="Branch (default: current)">
                    </div>
                    <textarea name="buildSteps"
                        placeholder="Build steps (one per line, e.g.):&#10;npm install&#10;npm run build"></textarea>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        <select name="healthMethod">
                            <option value="">No health check</option>
                            <option value="http">HTTP endpoint</option>
                            <option value="port">Port listening</option>
                            <option value="process">Process running</option>
                        </select>
                        <input type="text" name="healthTarget" placeholder="Health target (URL/port/name)">
                        <input type="number" name="healthTimeout" placeholder="Timeout (30s)" value="30">
                    </div>
                    <button type="submit">ğŸš€ Deploy</button>
                </form>
            </div>

            <!-- Rollback -->
            <div class="form-container">
                <h3>âª Rollback</h3>
                <form id="rollback-form">
                    <input type="text" name="appName" placeholder="App name" required>
                    <input type="text" name="commitHash" placeholder="Commit hash (optional, uses last successful)">
                    <button type="submit" class="btn-secondary">Rollback</button>
                </form>
            </div>

            <!-- Deployment History -->
            <div class="form-container">
                <h3>ğŸ“œ Deployment History</h3>
                <form id="history-form">
                    <input type="text" name="appName" placeholder="App name" required>
                    <button type="submit">View History</button>
                </form>
            </div>

            <!-- Health Check -->
            <div class="form-container full-width">
                <h3>ğŸ¥ Run Health Check</h3>
                <form id="health-form">
                    <div style="display: grid; grid-template-columns: 1fr 2fr 1fr; gap: 10px;">
                        <select name="method" required>
                            <option value="http">HTTP</option>
                            <option value="port">Port</option>
                            <option value="process">Process</option>
                            <option value="command">Command</option>
                        </select>
                        <input type="text" name="target" placeholder="Target (URL, port, process name, or command)"
                            required>
                        <input type="number" name="timeout" placeholder="Timeout" value="30">
                    </div>
                    <button type="submit">Run Health Check</button>
                </form>
            </div>
        </div>

        <!-- Results Display -->
        <div id="deploy-results" class="results-display"></div>
    </div>

    <script src="js/common.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const result = createResultDisplay('deploy-results');

            // Deploy
            document.getElementById('deploy-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                result.showLoading('Deploying... This may take a while.');

                const form = e.target;
                const formData = new FormData(form);

                const buildStepsRaw = formData.get('buildSteps');
                const buildSteps = buildStepsRaw
                    ? buildStepsRaw.split('\n').map(s => s.trim()).filter(s => s)
                    : [];

                const healthMethod = formData.get('healthMethod');
                const healthCheck = healthMethod ? {
                    method: healthMethod,
                    target: formData.get('healthTarget'),
                    timeout: parseInt(formData.get('healthTimeout')) || 30
                } : undefined;

                try {
                    const res = await apiPost('/deploy/trigger', {
                        appName: formData.get('appName'),
                        branch: formData.get('branch') || undefined,
                        buildSteps,
                        healthCheck
                    });

                    if (res.success) {
                        result.showSuccess(res.message);
                    } else {
                        result.showError(res.message);
                    }
                } catch (e) {
                    if (e.message === 'UNAUTHORIZED') {
                        result.showUnauthorized();
                    } else {
                        result.showError(e.message);
                    }
                }
            });

            // Rollback
            handleFormSubmit(
                document.getElementById('rollback-form'),
                '/deploy/rollback',
                result
            );

            // History
            document.getElementById('history-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                result.showLoading();

                const formData = new FormData(e.target);
                try {
                    const res = await apiPost('/deploy/history', {
                        appName: formData.get('appName')
                    });

                    if (res.success && res.data) {
                        result.showData(res.data.history, 'Deployment History');
                    } else {
                        result.showWarning(res.message || 'No history found');
                    }
                } catch (e) {
                    if (e.message === 'UNAUTHORIZED') {
                        result.showUnauthorized();
                    } else {
                        result.showError(e.message);
                    }
                }
            });

            // Health Check
            handleFormSubmit(
                document.getElementById('health-form'),
                '/deploy/health',
                result,
                (data) => ({
                    method: data.method,
                    target: data.target,
                    timeout: parseInt(data.timeout) || 30
                })
            );
        });
    </script>
</body>

</html>