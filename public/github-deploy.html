<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Launch - okastr8</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        :root {
            --term-bg: #1a1b26;
            --term-text: #a9b1d6;
            --term-accent: #7aa2f7;
            --term-success: #9ece6a;
            --term-error: #f7768e;
            --term-warning: #e0af68;
        }

        body {
            padding: 20px 40px;
            background: #FDF9F3;
        }

        .deploy-hero {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 24px 24px 0 0;
            padding: 40px;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .deploy-hero::after {
            content: '';
            position: absolute;
            top: -100px;
            right: -100px;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0) 70%);
            border-radius: 50%;
        }

        .repo-badge {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(8px);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 20px;
        }

        .deploy-title {
            font-size: 32px;
            font-weight: 800;
            margin: 0;
            letter-spacing: -1px;
        }

        .deploy-meta {
            margin-top: 12px;
            opacity: 0.8;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .deploy-card {
            background: white;
            border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.05);
            margin-top: -30px;
            position: relative;
            z-index: 10;
            display: grid;
            grid-template-columns: 380px 1fr;
            min-height: 650px;
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .deploy-sidebar {
            padding: 40px;
            border-right: 1px solid #f1f5f9;
            display: flex;
            flex-direction: column;
            gap: 32px;
        }

        .deploy-main {
            background: #f8fafc;
            padding: 0;
            display: flex;
            flex-direction: column;
        }

        /* Form Group refinements */
        .form-label {
            font-size: 13px;
            font-weight: 700;
            color: #475569;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            display: block;
        }

        .config-pill {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            border-radius: 14px;
            font-size: 14px;
            font-weight: 600;
        }

        .config-pill.checking {
            background: #f1f5f9;
            color: #64748b;
        }

        .config-pill.success {
            background: #ecfdf5;
            color: #059669;
            border: 1px solid #10b98120;
        }

        .config-pill.warning {
            background: #fffbeb;
            color: #d97706;
            border: 1px solid #fbbf2420;
        }

        /* Env Section Refinement */
        .env-container {
            background: #f8fafc;
            border-radius: 16px;
            padding: 20px;
            border: 1px solid #edf2f7;
        }

        .env-drop {
            background: white;
            border: 2px dashed #cbd5e0;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .env-drop:hover {
            border-color: #6366f1;
            background: #f5f3ff;
        }

        .env-drop.dragover {
            background: #eef2ff;
            border-color: #4f46e5;
            transform: scale(1.02);
        }

        .env-list {
            margin-top: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .env-item {
            display: flex;
            gap: 8px;
            background: white;
            padding: 4px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
        }

        .env-item:hover {
            border-color: #cbd5e0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        }

        .env-item input {
            border: none;
            background: transparent;
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            font-size: 12px;
            padding: 8px;
        }

        .env-item input:first-child {
            font-weight: 700;
            width: 40%;
            color: #475569;
        }

        .env-item input:focus {
            outline: none;
        }

        /* Live Terminal Aesthetic */
        .terminal {
            background: var(--term-bg);
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .terminal-header {
            background: #24283b;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .terminal-controls {
            display: flex;
            gap: 6px;
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            opacity: 0.8;
        }

        .dot.red {
            background: #f7768e;
        }

        .dot.yellow {
            background: #e0af68;
        }

        .dot.green {
            background: #9ece6a;
        }

        .terminal-body {
            padding: 24px;
            font-family: 'JetBrains Mono', 'Fira Code', 'Cascadia Code', monospace;
            font-size: 13px;
            color: var(--term-text);
            line-height: 1.7;
            overflow-y: auto;
            flex: 1;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade {
            animation: fadeIn 0.4s ease-out forwards;
        }

        /* Success Overlay */
        .overlay {
            position: absolute;
            inset: 0;
            background: rgba(26, 27, 38, 0.9);
            backdrop-filter: blur(10px);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            text-align: center;
            padding: 40px;
        }

        .overlay.active {
            display: flex;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background: #9ece6a;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1a1b26;
            margin-bottom: 24px;
            box-shadow: 0 0 40px rgba(158, 206, 106, 0.4);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        .launch-btn {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            width: 100%;
            padding: 18px;
            border-radius: 16px;
            font-weight: 700;
            font-size: 16px;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            margin-top: auto;
            border: none;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.2);
        }

        .launch-btn:hover:not(:disabled) {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 15px 30px rgba(99, 102, 241, 0.3);
        }

        .launch-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        .spinner-small {
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="container animate-fade">
        <header>
            <div class="header-group">
                <a href="github.html" class="back-arrow">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"></path>
                    </svg>
                </a>
                <h1>Launch Sequence</h1>
            </div>
        </header>

        <section class="deploy-hero">
            <div class="repo-badge">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                    style="width: 14px; height: 14px;">
                    <path
                        d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22">
                    </path>
                </svg>
                <span id="repo-name-text">Loading...</span>
            </div>
            <h2 class="deploy-title">Ready for Liftoff</h2>
            <div class="deploy-meta">
                <span id="target-app">Target: <code id="app-name-code"
                        style="color: #fbbf24; font-weight: 700;">-</code></span>
                <span style="opacity: 0.5;">|</span>
                <span id="deploy-mode">Runtime: <strong style="color: #93c5fd;">Docker</strong></span>
            </div>
        </section>

        <div class="deploy-card">
            <aside class="deploy-sidebar">
                <div class="form-group">
                    <label class="form-label">Repository Status</label>
                    <div id="config-pill" class="config-pill checking">
                        <span class="spinner-small" style="border-top-color: #64748b;"></span> Validating repository...
                    </div>
                </div>

                <form id="deploy-form" style="display: flex; flex-direction: column; gap: 24px; flex: 1;">
                    <div class="form-group">
                        <label class="form-label">Select Branch</label>
                        <select id="branch-select" class="form-control"
                            style="background: #f8fafc; border-radius: 14px; padding: 14px; font-weight: 600;">
                            <option>Loading branches...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Automation</label>
                        <div
                            style="background: #f8fafc; padding: 16px; border-radius: 14px; border: 1px solid #edf2f7;">
                            <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; margin: 0;">
                                <input type="checkbox" id="webhook-toggle" checked
                                    style="width: 20px; height: 20px; border-radius: 6px; accent-color: #646df2;">
                                <div>
                                    <div style="font-weight: 700; color: #1e293b; font-size: 14px;">Webhooks</div>
                                    <div style="font-size: 12px; color: #64748b;">Auto-deploy on every push</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Environment Variables</label>
                        <div class="env-container">
                            <div id="env-drop" class="env-drop">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                    style="width: 24px; height: 24px; margin-bottom: 8px; color: #94a3b8;">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17 8 12 3 7 8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                </svg>
                                <div style="font-size: 12px; color: #64748b; font-weight: 600;">Drop
                                    <strong>.env</strong> or click to upload</div>
                                <input type="file" id="env-file-input" accept=".env,.txt" style="display: none;">
                            </div>
                            <div id="env-list" class="env-list"></div>
                            <button type="button" onclick="addManualEnv()"
                                style="margin-top: 12px; font-size: 12px; font-weight: 700; color: #6366f1; background: none; border: 1px dashed #6366f140; padding: 8px; border-radius: 10px; width: 100%; cursor: pointer;">
                                + Add Manually
                            </button>
                        </div>
                    </div>

                    <button type="submit" id="deploy-btn" class="launch-btn">
                        Trigger Deployment
                    </button>
                </form>
            </aside>

            <main class="deploy-main">
                <div class="terminal">
                    <div class="terminal-header">
                        <div class="terminal-controls">
                            <div class="dot red"></div>
                            <div class="dot yellow"></div>
                            <div class="dot green"></div>
                        </div>
                        <div
                            style="color: rgba(255,255,255,0.4); font-size: 11px; font-weight: 700; font-family: monospace;">
                            DEPLOY_CONSOLE v2.0</div>
                    </div>
                    <div id="logs-view" class="terminal-body">
                        <span style="color: var(--term-accent);"># Ready to deployment</span>
                        <br>
                        <span style="opacity: 0.5;">Waiting for user trigger...</span>
                    </div>

                    <div id="success-overlay" class="overlay">
                        <div class="success-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
                                style="width: 40px; height: 40px;">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        </div>
                        <h2 style="color: white; font-size: 32px; font-weight: 800; margin-bottom: 8px;">Deployment
                            Successful</h2>
                        <p style="color: #a9b1d6; font-size: 16px; margin-bottom: 32px;">Your application has been
                            successfully staged and is now online.</p>
                        <button class="btn btn-primary" onclick="window.location.href='apps.html'"
                            style="padding: 16px 40px; font-size: 16px; border-radius: 16px; background: white; color: #1a1b26;">
                            Go to Dashboard
                        </button>
                    </div>
                </div>
            </main>
        </div>
        <div id="toast-layer" class="results-display"
            style="position: fixed; bottom: 40px; right: 40px; z-index: 1000; background: none;"></div>
    </div>

    <script src="js/common.js"></script>
    <script>
        const params = new URLSearchParams(window.location.search);
        const repoFullName = params.get('repo');
        const defaultBranch = params.get('branch') || 'main';
        let envVars = {};

        if (!repoFullName) { window.location.href = 'github.html'; }

        document.getElementById('repo-name-text').textContent = repoFullName;
        const appName = repoFullName.split('/')[1].toLowerCase().replace(/[^a-z0-9-]/g, '-');
        document.getElementById('app-name-code').textContent = appName;

        document.addEventListener('DOMContentLoaded', async () => {
            const branchSelect = document.getElementById('branch-select');
            try {
                const res = await apiPost('/github/branches', { repoFullName });
                if (res.success && res.data.branches?.length) {
                    branchSelect.innerHTML = res.data.branches.map(b =>
                        `<option value="${b}" ${b === defaultBranch ? 'selected' : ''}>${b}</option>`
                    ).join('');
                } else {
                    branchSelect.innerHTML = `<option value="${defaultBranch}">${defaultBranch}</option>`;
                }
            } catch (e) {
                branchSelect.innerHTML = `<option value="${defaultBranch}">${defaultBranch}</option>`;
            }

            checkConfig(repoFullName, branchSelect.value);
            branchSelect.onchange = () => checkConfig(repoFullName, branchSelect.value);

            const drop = document.getElementById('env-drop');
            const fileInput = document.getElementById('env-file-input');
            drop.onclick = () => fileInput.click();
            fileInput.onchange = (e) => { if (e.target.files.length) handleEnvFile(e.target.files[0]); };
            drop.ondragover = (e) => { e.preventDefault(); drop.classList.add('dragover'); };
            drop.ondragleave = () => drop.classList.remove('dragover');
            drop.ondrop = (e) => {
                e.preventDefault();
                drop.classList.remove('dragover');
                if (e.dataTransfer.files.length) handleEnvFile(e.dataTransfer.files[0]);
            };

            document.getElementById('deploy-form').addEventListener('submit', (e) => {
                e.preventDefault();
                startDeployment();
            });
        });

        async function checkConfig(repo, branch) {
            const pill = document.getElementById('config-pill');
            pill.className = 'config-pill checking';
            pill.innerHTML = '<span class="spinner-small" style="border-top-color: #64748b;"></span> Validating branch ' + branch + '...';

            try {
                const res = await apiPost('/github/check-config', { repoFullName: repo, ref: branch });
                if (res.success && res.data.hasConfig) {
                    pill.className = 'config-pill success';
                    pill.innerHTML = '✅ okastr8.yaml found';
                } else {
                    pill.className = 'config-pill warning';
                    pill.innerHTML = '⚠️ No configuration found';
                }
            } catch (e) {
                pill.className = 'config-pill warning';
                pill.innerHTML = '⚠️ Offline check failed';
            }
        }

        function addManualEnv(key = '', value = '') {
            const list = document.getElementById('env-list');
            const id = 'env-' + Math.random().toString(36).substr(2, 9);
            const div = document.createElement('div');
            div.className = 'env-item';
            div.id = id;
            div.innerHTML = `
                <input type="text" placeholder="KEY" value="${key}" onchange="updateEnvData()">
                <input type="text" placeholder="VALUE" value="${value}" onchange="updateEnvData()">
                <button type="button" style="padding:4px; color:#cbd5e0; background:none; border:none; cursor:pointer;" onclick="document.getElementById('${id}').remove(); updateEnvData()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="width: 14px; height: 14px;"><path d="M18 6L6 18M6 6l12 12"></path></svg>
                </button>
            `;
            list.appendChild(div);
            list.scrollTop = list.scrollHeight;
        }

        async function handleEnvFile(file) {
            const text = await file.text();
            const lines = text.split('\n');
            let count = 0;
            lines.forEach(line => {
                line = line.trim();
                if (!line || line.startsWith('#')) return;
                const eq = line.indexOf('=');
                if (eq > 0) {
                    const k = line.substring(0, eq).trim();
                    const v = line.substring(eq + 1).trim().replace(/^["'](.*)["']$/, '$1');
                    addManualEnv(k, v);
                    count++;
                }
            });
            showToast(`Imported ${count} variables from ${file.name}`, 'success');
        }

        function updateEnvData() {
            const data = {};
            document.querySelectorAll('.env-item').forEach(item => {
                const pk = item.querySelectorAll('input');
                if (pk[0].value.trim()) data[pk[0].value.trim()] = pk[1].value.trim();
            });
            envVars = data;
        }

        async function startDeployment() {
            updateEnvData();
            const btn = document.getElementById('deploy-btn');
            const logs = document.getElementById('logs-view');

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-small"></span> Deploying...';
            logs.innerHTML = '<div style="color: var(--term-accent); font-weight: bold;">[SYSTEM] Initializing deployment sequence...</div>';

            try {
                const res = await apiPost('/github/import', {
                    repoFullName,
                    branch: document.getElementById('branch-select').value,
                    setupWebhook: document.getElementById('webhook-toggle').checked,
                    env: envVars
                });

                if (!res.success || !res.data?.deploymentId) {
                    logs.innerHTML += `<div style="color: var(--term-error); margin-top: 8px;">[ERROR] ${res.message || 'Fatal initialization error'}</div>`;
                    btn.disabled = false;
                    btn.innerHTML = 'Retry Deployment';
                    return;
                }

                const es = new EventSource(`/api/github/deploy-stream/${res.data.deploymentId}`);
                let ok = null;

                es.onmessage = (e) => {
                    const d = JSON.parse(e.data);
                    if (d.type === 'log') {
                        let col = 'var(--term-text)';
                        if (d.message.includes('✅') || d.message.includes('succeeded')) col = 'var(--term-success)';
                        if (d.message.includes('❌') || d.message.includes('failed')) col = 'var(--term-error)';
                        if (d.message.includes('⚠️') || d.message.includes('warning')) col = 'var(--term-warning)';
                        if (d.message.startsWith('==')) col = 'var(--term-accent)';

                        logs.innerHTML += `<div style="color: ${col}">${escapeHtml(d.message)}</div>`;
                        logs.scrollTop = logs.scrollHeight;

                        if (d.message.includes('Deployment succeeded')) ok = true;
                        if (d.message.includes('Deployment failed')) ok = false;
                    } else if (d.type === 'end') {
                        es.close();
                        if (ok) {
                            document.getElementById('success-overlay').classList.add('active');
                        } else {
                            btn.disabled = false;
                            btn.innerHTML = 'Retry Deployment';
                        }
                    }
                };
            } catch (err) {
                logs.innerHTML += `<div style="color: var(--term-error);">[FATAL] ${err.message}</div>`;
                btn.disabled = false;
            }
        }

        function showToast(m, t) {
            const r = createResultDisplay('toast-layer');
            if (t === 'success') r.showSuccess(m);
            else r.showError(m);
            setTimeout(() => r.clear(), 3000);
        }

        function escapeHtml(t) {
            const d = document.createElement('div');
            d.textContent = t;
            return d.innerHTML;
        }
    </script>
</body>

</html>