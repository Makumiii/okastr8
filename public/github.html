<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub - okastr8</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .github-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #24292e 0%, #1b1f23 100%);
            border-radius: 8px;
            color: white;
        }

        .github-header h2 {
            margin: 0;
            color: white;
            border: none;
            padding: 0;
        }

        .github-status {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        /* Glowing status indicator */
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            border-radius: 24px;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-indicator.connected {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
        }

        .status-indicator.disconnected {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse-glow 2s infinite;
        }

        .status-dot.connected {
            background: #22c55e;
            box-shadow: 0 0 8px #22c55e, 0 0 16px rgba(34, 197, 94, 0.4);
        }

        .status-dot.disconnected {
            background: #ef4444;
            box-shadow: 0 0 8px #ef4444, 0 0 16px rgba(239, 68, 68, 0.4);
        }

        @keyframes pulse-glow {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.7;
                transform: scale(1.1);
            }
        }

        .connect-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .connect-btn.connect {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
        }

        .connect-btn.connect:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
        }

        .connect-btn.disconnect {
            background: #374151;
            color: white;
        }

        .connect-btn.disconnect:hover {
            background: #ef4444;
        }

        /* Icon styles */
        .icon {
            width: 20px;
            height: 20px;
            display: inline-block;
        }

        .repo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .repo-card {
            background: white;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            padding: 16px;
            transition: box-shadow 0.2s, transform 0.2s;
        }

        .repo-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .repo-name {
            font-size: 16px;
            font-weight: 600;
            color: #0366d6;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .repo-name:hover {
            text-decoration: underline;
        }

        .repo-private {
            background: #ffd33d;
            color: #24292e;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 500;
        }

        .repo-desc {
            color: #586069;
            font-size: 14px;
            margin: 8px 0;
            line-height: 1.4;
        }

        .repo-meta {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: #586069;
            margin-top: 12px;
        }

        .repo-lang {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .lang-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #3178c6;
        }

        .repo-actions {
            margin-top: 12px;
            display: flex;
            gap: 8px;
        }

        /* Environment Variables UI */
        .env-drop-zone {
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            background: #f9fafb;
            transition: all 0.2s;
            cursor: pointer;
            margin-top: 10px;
        }

        .env-drop-zone:hover {
            border-color: #0366d6;
            background: #f0f4ff;
        }

        .env-drop-zone.dragover {
            border-color: #0366d6;
            background: #e0e7ff;
            box-shadow: 0 0 20px rgba(3, 102, 214, 0.2);
        }

        .env-var-item {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            align-items: center;
        }

        .env-var-item input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 13px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
        }

        .env-var-item input:first-child {
            flex: 0.4;
        }

        .env-var-item button {
            padding: 6px 10px;
            background: #fee2e2;
            color: #dc2626;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.15s;
        }

        .env-var-item button:hover {
            background: #fecaca;
        }

        .env-file-status {
            margin-top: 12px;
            padding: 10px 14px;
            background: #dcfce7;
            border: 1px solid #86efac;
            border-radius: 8px;
            font-size: 13px;
            color: #166534;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-link {
            background: none;
            border: none;
            color: #0366d6;
            cursor: pointer;
            padding: 0;
            font-size: 13px;
            text-decoration: underline;
        }

        .btn-link:hover {
            text-decoration: none;
        }

        .search-box {
            padding: 10px 15px;
            font-size: 16px;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            width: 100%;
            max-width: 400px;
        }

        .filter-bar {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
        }

        .setup-card {
            background: #f6f8fa;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .setup-card h3 {
            margin-top: 0;
        }

        .setup-card code {
            background: #24292e;
            color: #f6f8fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 13px;
        }

        .deploy-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .deploy-modal.active {
            display: flex;
        }

        .deploy-modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .deploy-modal-content h3 {
            margin-top: 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="header-group">
                <a href="index.html" class="back-arrow">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"></path>
                    </svg>
                </a>
                <h1>
                    <svg class="icon" viewBox="0 0 24 24" fill="currentColor"
                        style="width: 32px; height: 32px; vertical-align: middle; margin-right: 8px;">
                        <path
                            d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" />
                    </svg>
                    GitHub Integration
                </h1>
            </div>
            <span id="auth-status" class="auth-status">Checking...</span>
        </header>



        <!-- GitHub Connection Status -->
        <div class="github-header">
            <div>
                <h2 style="display: flex; align-items: center; gap: 10px;">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        style="width: 24px; height: 24px;">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                    Your Repositories
                </h2>
                <p id="github-user" style="margin: 5px 0 0; opacity: 0.8;"></p>
            </div>
            <div class="github-status">
                <div id="connection-status" class="status-indicator disconnected">
                    <span class="status-dot disconnected"></span>
                    <span class="status-text">Disconnected</span>
                </div>
                <button id="connection-btn" class="connect-btn connect" onclick="handleConnectionAction()">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        style="width: 18px; height: 18px;">
                        <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
                        <polyline points="10 17 15 12 10 7"></polyline>
                        <line x1="15" y1="12" x2="3" y2="12"></line>
                    </svg>
                    <span id="connection-btn-text">Connect</span>
                </button>
            </div>
        </div>

        <!-- Setup Instructions (shown when not configured) -->
        <div id="setup-section" class="setup-card" style="display: none;">
            <h3 style="display: flex; align-items: center; gap: 8px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    style="width: 20px; height: 20px;">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path
                        d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                    </path>
                </svg>
                Setup Required
            </h3>
            <p>To connect GitHub, you need to create an OAuth App:</p>
            <ol>
                <li>Go to <a href="https://github.com/settings/developers" target="_blank">GitHub Developer Settings</a>
                </li>
                <li>Click "New OAuth App"</li>
                <li>Set Homepage URL: <code id="homepage-url">http://localhost:8788</code></li>
                <li>Set Callback URL: <code id="callback-url">http://localhost:8788/api/github/callback</code></li>
                <li>Copy Client ID and Client Secret</li>
                <li>Add to <code>~/.okastr8/system.yaml</code>:
                    <pre
                        style="background: #24292e; color: #f6f8fa; padding: 10px; border-radius: 4px; overflow-x: auto;">
manager:
  github:
    client_id: YOUR_CLIENT_ID
    client_secret: YOUR_CLIENT_SECRET</pre>
                </li>
                <li>Restart the server and refresh this page</li>
            </ol>
        </div>

        <!-- Repository List (shown when connected) -->
        <div id="repos-section" style="display: none;">
            <div class="filter-bar">
                <input type="text" id="search-repos" class="search-box" placeholder="Search repositories...">
                <select id="filter-lang" style="padding: 10px;">
                    <option value="">All languages</option>
                </select>
                <button id="refresh-repos" class="btn btn-secondary"
                    style="display: flex; align-items: center; gap: 6px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        style="width: 16px; height: 16px;">
                        <polyline points="23 4 23 10 17 10"></polyline>
                        <polyline points="1 20 1 14 7 14"></polyline>
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                    </svg>
                    Refresh
                </button>
            </div>

            <div id="repos-grid" class="repo-grid"></div>
        </div>

        <!-- Results Display -->
        <div id="github-results" class="results-display"></div>
    </div>

    <!-- Deploy Modal -->
    <div id="deploy-modal" class="deploy-modal">
        <div class="deploy-modal-content">
            <h3>üöÄ Deploy Repository</h3>
            <div id="deploy-app-name-display"
                style="background: #f6f8fa; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 14px; color: #24292e;">
                <strong>App Name:</strong> <code id="deploy-app-name-text"
                    style="background: #e1e4e8; padding: 2px 6px; border-radius: 3px;"></code>
            </div>
            <form id="deploy-form">
                <input type="hidden" id="deploy-repo-name" name="repoFullName">

                <label>Branch</label>
                <select id="deploy-branch" name="branch"
                    style="width: 100%; padding: 10px; margin-bottom: 15px; border-radius: 6px; border: 1px solid #ccc;">
                    <option>Loading...</option>
                </select>

                <div
                    style="background: #f6f8fa; padding: 12px; border-radius: 6px; margin-bottom: 15px; font-size: 13px; color: #586069;">
                    <strong>‚ÑπÔ∏è Configuration Required</strong><br>
                    Your repository must have an <code>okastr8.yaml</code> file in the root defining:
                    runtime, build steps, start command, port, etc.
                </div>

                <label style="display:flex; align-items:center; gap:8px; margin-top:10px;">
                    <input type="checkbox" id="deploy-webhook" name="setupWebhook" checked>
                    Enable Auto-Deploy (Webhook)
                </label>

                <!-- Environment Variables Section -->
                <div style="border-top: 1px solid #e1e4e8; padding-top: 15px; margin-top: 20px;">
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; font-weight: 600;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            style="width: 18px; height: 18px;">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                        </svg>
                        Environment Variables
                    </label>

                    <div id="env-drop-zone" class="env-drop-zone">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            style="width: 24px; height: 24px; margin-bottom: 8px; color: #586069;">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        <div style="font-size: 13px;">
                            <strong>Drop .env file here</strong> or
                            <label for="env-file-input"
                                style="color: #0366d6; cursor: pointer; text-decoration: underline;">browse</label>
                        </div>
                        <input type="file" id="env-file-input" accept=".env,.txt" style="display: none;">
                    </div>

                    <div style="margin-top: 12px;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-size: 12px; color: #586069;">Manual Entry:</span>
                            <button type="button" class="btn-link" onclick="addEnvVar()">+ Add Variable</button>
                        </div>
                        <div id="env-vars-list">
                            <!-- Env var items will be added here -->
                        </div>
                    </div>
                </div>

                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-primary">üöÄ Deploy</button>
                    <button type="button" id="cancel-deploy" class="btn btn-cancel">Cancel</button>
                </div>
            </form>
            <div id="deploy-result" style="margin-top: 15px;"></div>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script>
        let allRepos = [];
        let envVariables = {};

        // Environment Variable Helpers
        function addEnvVar(key = '', value = '') {
            const list = document.getElementById('env-vars-list');
            const id = 'env-' + Math.random().toString(36).substr(2, 9);

            const div = document.createElement('div');
            div.className = 'env-var-item';
            div.id = id;
            div.innerHTML = `
                <input type="text" placeholder="KEY" value="${key}" class="env-key" oninput="updateEnvVar('${id}')">
                <input type="text" placeholder="VALUE" value="${value}" class="env-value" oninput="updateEnvVar('${id}')">
                <button type="button" onclick="removeEnvVar('${id}')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            `;
            list.appendChild(div);
            updateEnvVar(id);
        }

        function removeEnvVar(id) {
            const el = document.getElementById(id);
            const key = el.querySelector('.env-key').value;
            if (key) delete envVariables[key];
            el.remove();
        }

        function updateEnvVar(id) {
            const el = document.getElementById(id);
            const key = el.querySelector('.env-key').value.trim();
            const value = el.querySelector('.env-value').value.trim();

            if (key) {
                envVariables[key] = value;
            }
        }

        function renderEnvVars() {
            const list = document.getElementById('env-vars-list');
            list.innerHTML = '';
            Object.entries(envVariables).forEach(([key, value]) => {
                addEnvVar(key, value);
            });
        }

        function parseEnvFile(content) {
            const vars = {};
            const lines = content.split('\n');
            lines.forEach(line => {
                line = line.trim();
                if (!line || line.startsWith('#')) return;

                const parts = line.split('=');
                if (parts.length >= 2) {
                    const key = parts[0].trim();
                    const value = parts.slice(1).join('=').trim();
                    // Remove quotes if present
                    const cleanValue = value.replace(/^["'](.*)["']$/, '$1');
                    vars[key] = cleanValue;
                }
            });
            return vars;
        }

        async function handleEnvFile(file) {
            const text = await file.text();
            const vars = parseEnvFile(text);
            envVariables = { ...envVariables, ...vars };
            renderEnvVars();

            const dropZone = document.getElementById('env-drop-zone');
            const originalContent = dropZone.innerHTML;
            dropZone.innerHTML = `
                <div class="env-file-status">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px;">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    Loaded ${Object.keys(vars).length} variables from ${file.name}
                </div>
            `;
            setTimeout(() => {
                dropZone.innerHTML = originalContent;
                // Re-attach listener if needed, but since we use onclick/onchange in HTML it's fine
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const result = createResultDisplay('github-results');

            // Check URL params for OAuth callback result
            const params = new URLSearchParams(window.location.search);
            if (params.get('connected')) {
                result.showSuccess(`Connected as ${params.get('user')}!`);
                history.replaceState({}, '', '/github.html');
            } else if (params.get('error')) {
                result.showError(`GitHub auth failed: ${params.get('error')}`);
                history.replaceState({}, '', '/github.html');
            }

            // Set URLs for setup instructions
            const host = window.location.host;
            document.getElementById('homepage-url').textContent = `http://${host}`;
            document.getElementById('callback-url').textContent = `http://${host}/api/github/callback`;

            await checkConnectionStatus();

            // Set up environment variable drag and drop
            const dropZone = document.getElementById('env-drop-zone');
            const fileInput = document.getElementById('env-file-input');

            if (dropZone && fileInput) {
                dropZone.onclick = () => fileInput.click();

                fileInput.onchange = (e) => {
                    if (e.target.files.length) handleEnvFile(e.target.files[0]);
                };

                dropZone.ondragover = (e) => {
                    e.preventDefault();
                    dropZone.classList.add('dragover');
                };

                dropZone.ondragleave = () => {
                    dropZone.classList.remove('dragover');
                };

                dropZone.ondrop = (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('dragover');
                    if (e.dataTransfer.files.length) {
                        handleEnvFile(e.dataTransfer.files[0]);
                    }
                };
            }
        });

        async function checkConnectionStatus() {
            const result = createResultDisplay('github-results');
            const statusIndicator = document.getElementById('connection-status');
            const statusDot = statusIndicator.querySelector('.status-dot');
            const statusText = statusIndicator.querySelector('.status-text');
            const connectionBtn = document.getElementById('connection-btn');
            const connectionBtnText = document.getElementById('connection-btn-text');

            try {
                const statusRes = await apiGet('/github/status');
                const status = statusRes.data;

                if (status.connected) {
                    // Update status indicator to connected (green glow)
                    statusIndicator.className = 'status-indicator connected';
                    statusDot.className = 'status-dot connected';
                    statusText.textContent = 'Connected';

                    // Update button to disconnect mode
                    connectionBtn.className = 'connect-btn disconnect';
                    connectionBtnText.textContent = 'Disconnect';

                    document.getElementById('github-user').textContent = `@${status.username}`;
                    document.getElementById('setup-section').style.display = 'none';
                    document.getElementById('repos-section').style.display = 'block';

                    await loadRepos();
                } else {
                    // Update status indicator to disconnected (red glow)
                    statusIndicator.className = 'status-indicator disconnected';
                    statusDot.className = 'status-dot disconnected';
                    statusText.textContent = 'Disconnected';

                    // Update button to connect mode
                    connectionBtn.className = 'connect-btn connect';
                    connectionBtnText.textContent = 'Connect';

                    document.getElementById('github-user').textContent = '';
                    document.getElementById('repos-section').style.display = 'none';

                    // Check if OAuth is configured
                    const authUrlRes = await apiGet('/github/auth-url');
                    if (!authUrlRes.success) {
                        document.getElementById('setup-section').style.display = 'block';
                        connectionBtn.style.display = 'none';
                    } else {
                        connectionBtn.style.display = 'flex';
                    }
                }
            } catch (e) {
                if (e.message === 'UNAUTHORIZED') {
                    result.showUnauthorized();
                } else {
                    result.showError(e.message);
                }
            }
        }

        // Unified connection action handler
        async function handleConnectionAction() {
            const connectionBtn = document.getElementById('connection-btn');
            const isConnected = connectionBtn.classList.contains('disconnect');

            if (isConnected) {
                // Disconnect
                if (confirm('Disconnect from GitHub?')) {
                    try {
                        await apiPost('/github/disconnect', {});
                        await checkConnectionStatus();
                    } catch (e) {
                        createResultDisplay('github-results').showError(e.message);
                    }
                }
            } else {
                // Connect - redirect to OAuth
                try {
                    const res = await apiGet('/github/auth-url');
                    if (res.success && res.data.authUrl) {
                        window.location.href = res.data.authUrl;
                    }
                } catch (e) {
                    createResultDisplay('github-results').showError(e.message);
                }
            }
        }

        async function loadRepos() {
            const result = createResultDisplay('github-results');
            result.showLoading('Loading repositories...');

            try {
                const res = await apiGet('/github/repos');
                if (res.success) {
                    allRepos = res.data.repos;
                    result.clear();
                    renderRepos(allRepos);
                    populateLanguageFilter(allRepos);
                } else {
                    result.showError(res.message);
                }
            } catch (e) {
                if (e.message === 'UNAUTHORIZED') {
                    result.showUnauthorized();
                } else {
                    result.showError(e.message);
                }
            }
        }

        function renderRepos(repos) {
            const grid = document.getElementById('repos-grid');

            if (repos.length === 0) {
                grid.innerHTML = '<p style="color: #586069;">No repositories found.</p>';
                return;
            }

            grid.innerHTML = repos.map(repo => `
                <div class="repo-card">
                    <a href="${repo.html_url}" target="_blank" class="repo-name">
                        <svg class="icon" viewBox="0 0 16 16" fill="currentColor" style="width:16px; height:16px; margin-right:6px; color:#586069;">
                            <path d="M2 2.5A2.5 2.5 0 0 1 4.5 0h8.75a.75.75 0 0 1 .75.75v12.5a.75.75 0 0 1-.75.75h-2.5a.75.75 0 1 1 0-1.5h1.75v-2h-8a1 1 0 0 0-.714 1.7.75.75 0 0 1-1.072 1.05A2.495 2.495 0 0 1 2 11.5v-9zm10.5-1V9h-8c-.356 0-.694.074-1 .208V2.5a1 1 0 0 1 1-1h8zM5 12.25v3.25a.25.25 0 0 0 .4.2l1.45-1.087a.25.25 0 0 1 .3 0L8.6 15.7a.25.25 0 0 0 .4-.2v-3.25a.25.25 0 0 0-.25-.25h-3.5a.25.25 0 0 0-.25.25z"></path>
                        </svg>
                        ${repo.name}
                        ${repo.private ? '<span class="repo-private">Private</span>' : ''}
                    </a>
                    <p class="repo-desc">${repo.description || 'No description'}</p>
                    <div class="repo-meta">
                        ${repo.language ? `<span class="repo-lang"><span class="lang-dot" style="background: ${getLanguageColor(repo.language)}"></span> ${repo.language}</span>` : ''}
                        <span>Updated ${formatDate(repo.pushed_at)}</span>
                    </div>
                    <div class="repo-actions">
                        <button type="button" class="btn btn-primary btn-small" onclick="openDeployModal('${repo.full_name}', '${repo.name}', '${repo.default_branch || 'main'}')">
                            üöÄ Deploy
                        </button>
                        <a href="${repo.html_url}" target="_blank" class="btn btn-secondary btn-small">View on GitHub</a>
                    </div>
                </div>
            `).join('');
        }

        function populateLanguageFilter(repos) {
            const languages = [...new Set(repos.map(r => r.language).filter(Boolean))].sort();
            const select = document.getElementById('filter-lang');
            select.innerHTML = '<option value="">All languages</option>' +
                languages.map(lang => `<option value="${lang}">${lang}</option>`).join('');
        }

        function getLanguageColor(language) {
            const colors = {
                JavaScript: '#f1e05a',
                TypeScript: '#3178c6',
                Python: '#3572A5',
                Go: '#00ADD8',
                Rust: '#dea584',
                Java: '#b07219',
                Ruby: '#701516',
                PHP: '#4F5D95',
                C: '#555555',
                'C++': '#f34b7d',
                'C#': '#178600',
                Swift: '#ffac45',
                Kotlin: '#A97BFF',
                Shell: '#89e051',
                HTML: '#e34c26',
                CSS: '#563d7c',
            };
            return colors[language] || '#8b8b8b';
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'today';
            if (diffDays === 1) return 'yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
            if (diffDays < 365) return `${Math.floor(diffDays / 30)} months ago`;
            return `${Math.floor(diffDays / 365)} years ago`;
        }

        // Search and filter
        document.getElementById('search-repos').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const langFilter = document.getElementById('filter-lang').value;

            const filtered = allRepos.filter(repo => {
                const matchesQuery = repo.name.toLowerCase().includes(query) ||
                    (repo.description && repo.description.toLowerCase().includes(query));
                const matchesLang = !langFilter || repo.language === langFilter;
                return matchesQuery && matchesLang;
            });

            renderRepos(filtered);
        });

        document.getElementById('filter-lang').addEventListener('change', () => {
            document.getElementById('search-repos').dispatchEvent(new Event('input'));
        });

        document.getElementById('refresh-repos').addEventListener('click', loadRepos);



        // Deploy modal
        async function openDeployModal(repoFullName, repoName, defaultBranch) {
            document.getElementById('deploy-repo-name').value = repoFullName;

            // Reset environment variables
            envVariables = {};
            document.getElementById('env-vars-list').innerHTML = '';
            const status = document.querySelector('.env-file-status');
            if (status) status.remove();

            // Set app name display
            const appName = repoName.toLowerCase().replace(/[^a-z0-9_-]/g, '-');
            document.getElementById('deploy-app-name-text').textContent = appName;

            const branchSelect = document.getElementById('deploy-branch');
            branchSelect.innerHTML = '<option>Loading...</option>';
            document.getElementById('deploy-result').innerHTML = '';
            document.getElementById('deploy-modal').classList.add('active');

            // Load Branches
            try {
                const res = await apiPost('/github/branches', { repoFullName });
                if (res.success && res.data.branches?.length) {
                    branchSelect.innerHTML = res.data.branches.map(b =>
                        `<option value="${b}" ${b === defaultBranch ? 'selected' : ''}>${b}</option>`
                    ).join('');
                } else {
                    branchSelect.innerHTML = `<option value="${defaultBranch}">${defaultBranch}</option>`;
                }
            } catch (e) {
                console.error("Failed to load branches", e);
                branchSelect.innerHTML = `<option value="${defaultBranch}">${defaultBranch}</option>`;
            }

            // Trigger Config Check
            checkConfiguration(repoFullName, branchSelect.value);

            // Add listener for branch change
            branchSelect.onchange = () => checkConfiguration(repoFullName, branchSelect.value);
        }

        async function checkConfiguration(repoFullName, branch) {
            const statusDiv = document.getElementById('config-check-status');
            const manualSection = document.getElementById('manual-config-section');

            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '‚è≥ Checking for configuration...';
            statusDiv.style.background = '#f6f8fa';
            statusDiv.style.color = '#586069';

            try {
                const res = await apiPost('/github/check-config', { repoFullName, ref: branch });
                if (res.success && res.data.hasConfig) {
                    statusDiv.innerHTML = '‚úÖ <strong>okastr8.yaml found!</strong> Using configuration from repository.';
                    statusDiv.style.background = '#dcffe4';
                    statusDiv.style.color = '#155225';
                    manualSection.style.display = 'none';
                } else {
                    statusDiv.innerHTML = '‚ö†Ô∏è <strong>No config found.</strong> Please configure manually below:';
                    statusDiv.style.background = '#fff5b1';
                    statusDiv.style.color = '#735c0f';
                    manualSection.style.display = 'block';
                }
            } catch (e) {
                statusDiv.innerHTML = '‚ö†Ô∏è Could not check config status.';
                manualSection.style.display = 'block';
            }
        }


        document.getElementById('cancel-deploy').addEventListener('click', () => {
            document.getElementById('deploy-modal').classList.remove('active');
        });

        document.getElementById('deploy-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const resultEl = document.getElementById('deploy-result');
            const formData = new FormData(e.target);
            const repoFullName = formData.get('repoFullName');
            const branch = formData.get('branch') || undefined;

            // Check for branch change before deploying
            try {
                const branchCheck = await apiPost('/github/check-branch-change', {
                    repoFullName,
                    branch
                });

                if (branchCheck.success && branchCheck.data?.branchChanged) {
                    // Show warning and get confirmation
                    const confirmed = confirm(
                        `‚ö†Ô∏è Branch Change Warning!\n\n` +
                        `Current branch: ${branchCheck.data.currentBranch}\n` +
                        `New branch: ${branchCheck.data.requestedBranch}\n\n` +
                        `${branchCheck.data.warning}\n\n` +
                        `Do you want to continue?`
                    );

                    if (!confirmed) {
                        resultEl.innerHTML = `<div class="result-status result-warning"><span class="result-icon">‚ö†Ô∏è</span><span class="result-message">Deployment cancelled - branch change not confirmed</span></div>`;
                        return;
                    }
                }
            } catch (err) {
                console.warn('Branch check failed, proceeding anyway:', err);
            }

            // Create logs container
            resultEl.innerHTML = `
                <div class="deployment-logs-container" style="max-height: 400px; overflow-y: auto; background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 6px; font-family: 'Consolas', monospace; font-size: 13px; line-height: 1.6;">
                    <div class="deployment-logs"></div>
                </div>
            `;
            const logsContainer = resultEl.querySelector('.deployment-logs');

            try {
                // Start deployment - config comes from okastr8.yaml
                const res = await apiPost('/github/import', {
                    repoFullName,
                    branch,
                    setupWebhook: document.getElementById('deploy-webhook').checked,
                    env: envVariables
                });

                if (!res.success || !res.data?.deploymentId) {
                    resultEl.innerHTML = `<div class="result-status result-error"><span class="result-icon">‚ùå</span><span class="result-message">${res.message || 'Deployment failed to start'}</span></div>`;
                    return;
                }

                const deploymentId = res.data.deploymentId;
                logsContainer.innerHTML += `<div style="color: #4ec9b0;">üöÄ Connecting to deployment stream...</div>`;

                // Connect to SSE stream
                const eventSource = new EventSource(`/api/github/deploy-stream/${deploymentId}`);
                let deploymentSucceeded = null;

                eventSource.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);

                        if (data.type === 'connected') {
                            logsContainer.innerHTML += `<div style="color: #4ec9b0;">‚úì Connected to deployment stream</div>`;
                        } else if (data.type === 'log') {
                            const logLine = escapeHtml(data.message);
                            // Color code based on content
                            let color = '#d4d4d4';
                            if (logLine.includes('‚úÖ') || logLine.includes('successfully')) color = '#4ec9b0';
                            if (logLine.includes('‚ùå') || logLine.includes('failed')) color = '#f48771';
                            if (logLine.includes('‚ö†Ô∏è') || logLine.includes('warning')) color = '#dcdcaa';

                            logsContainer.innerHTML += `<div style="color: ${color};">${logLine}</div>`;
                            logsContainer.parentElement.scrollTop = logsContainer.parentElement.scrollHeight;

                            // Capture success/failure
                            if (logLine.includes('Deployment succeeded')) deploymentSucceeded = true;
                            if (logLine.includes('Deployment failed')) deploymentSucceeded = false;
                        } else if (data.type === 'end') {
                            eventSource.close();
                            logsContainer.innerHTML += `<div style="color: #4ec9b0; margin-top: 10px;">‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ</div>`;
                            logsContainer.innerHTML += `<div style="color: ${deploymentSucceeded ? '#4ec9b0' : '#f48771'}; font-weight: bold; margin-top: 5px;">${deploymentSucceeded ? '‚úÖ Deployment Complete!' : '‚ùå Deployment Failed'}</div>`;

                            if (deploymentSucceeded) {
                                setTimeout(() => {
                                    document.getElementById('deploy-modal').classList.remove('active');
                                    window.location.href = 'apps.html';
                                }, 2000);
                            }
                        }
                    } catch (err) {
                        console.error('Error parsing SSE message:', err);
                    }
                };

                eventSource.onerror = (error) => {
                    console.error('SSE Error:', error);
                    eventSource.close();
                    logsContainer.innerHTML += `<div style="color: #f48771; margin-top: 10px;">‚ö†Ô∏è Connection lost. Deployment may still be running in background.</div>`;
                };

            } catch (e) {
                resultEl.innerHTML = `<div class="result-status result-error"><span class="result-icon">‚ùå</span><span class="result-message">${e.message}</span></div>`;
            }
        });
    </script>
</body>

</html>