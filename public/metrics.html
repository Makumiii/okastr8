<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metrics - okastr8</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        /* Metrics-specific styles */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        .system-overview {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .progress-ring {
            width: 80px;
            height: 80px;
            position: relative;
        }

        .progress-ring-circle {
            fill: none;
            stroke: #E5E7EB;
            stroke-width: 8;
        }

        .progress-ring-value {
            fill: none;
            stroke: var(--accent-purple);
            stroke-width: 8;
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: center;
            transition: stroke-dashoffset 0.3s ease;
        }

        .progress-ring-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            font-weight: 600;
        }

        .service-card {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .service-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .service-name {
            font-weight: 600;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .service-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .metric-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .metric-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .metric-value {
            font-size: 20px;
            font-weight: 500;
        }

        .metric-value.small {
            font-size: 16px;
        }

        .progress-bar-container {
            width: 100%;
            height: 6px;
            background: #E5E7EB;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .progress-bar-fill.cpu {
            background: var(--accent-purple);
        }

        .progress-bar-fill.memory {
            background: #F59E0B;
        }

        .refresh-indicator {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .pulse-dot {
            width: 8px;
            height: 8px;
            background: #22C55E;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .load-averages {
            display: flex;
            gap: 16px;
            margin-top: 8px;
        }

        .load-item {
            text-align: center;
        }

        .load-value {
            font-size: 18px;
            font-weight: 500;
        }

        .load-label {
            font-size: 11px;
            color: var(--text-secondary);
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>okastr8</h1>
            <nav>
                <a href="index.html">Dashboard</a>
                <a href="github.html">GitHub</a>
                <a href="apps.html">Apps</a>
                <a href="#" class="active">Metrics</a>
                <a href="user.html">Users</a>
                <a href="setup.html">Settings</a>
            </nav>
            <div class="refresh-indicator">
                <div class="pulse-dot"></div>
                <span>Live</span>
            </div>
        </header>

        <div id="metrics-content">
            <div class="bento-card" style="text-align: center; padding: 60px;">
                <div class="spinner"></div>
                <p style="margin-top: 16px; color: var(--text-secondary);">Loading metrics...</p>
            </div>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script>
        let metricsInterval = null;

        function createProgressRing(percent, size = 80) {
            const strokeWidth = 8;
            const radius = (size - strokeWidth) / 2;
            const circumference = radius * 2 * Math.PI;
            const offset = circumference - (percent / 100) * circumference;

            return `
                <div class="progress-ring" style="width: ${size}px; height: ${size}px;">
                    <svg width="${size}" height="${size}">
                        <circle class="progress-ring-circle" 
                            cx="${size / 2}" cy="${size / 2}" r="${radius}"/>
                        <circle class="progress-ring-value" 
                            cx="${size / 2}" cy="${size / 2}" r="${radius}"
                            style="stroke-dasharray: ${circumference}; stroke-dashoffset: ${offset};"/>
                    </svg>
                    <div class="progress-ring-text">${Math.round(percent)}%</div>
                </div>
            `;
        }

        function getStatusColor(status) {
            switch (status) {
                case 'running': return '#22C55E';
                case 'stopped': return '#9CA3AF';
                case 'failed': return '#EF4444';
                default: return '#9CA3AF';
            }
        }

        function formatBytes(mb) {
            if (mb >= 1024) {
                return (mb / 1024).toFixed(1) + ' GB';
            }
            return mb + ' MB';
        }

        async function loadMetrics() {
            try {
                const response = await fetch('/api/system/metrics');
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.message);
                }

                const { system, services } = result.data;
                const container = document.getElementById('metrics-content');

                container.innerHTML = `
                    <!-- System Overview -->
                    <div class="system-overview">
                        <!-- CPU Card -->
                        <div class="bento-card">
                            <div class="card-label">
                                CPU Usage
                                <div class="card-icon-small">‚ö°</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 20px; margin-top: 12px;">
                                ${createProgressRing(system.cpu.usage)}
                                <div>
                                    <div class="metric-big" style="font-size: 28px;">${system.cpu.usage}%</div>
                                    <div style="color: var(--text-secondary); font-size: 13px;">${system.cpu.cores} cores</div>
                                </div>
                            </div>
                            <div class="load-averages">
                                <div class="load-item">
                                    <div class="load-value">${system.load[0]}</div>
                                    <div class="load-label">1m</div>
                                </div>
                                <div class="load-item">
                                    <div class="load-value">${system.load[1]}</div>
                                    <div class="load-label">5m</div>
                                </div>
                                <div class="load-item">
                                    <div class="load-value">${system.load[2]}</div>
                                    <div class="load-label">15m</div>
                                </div>
                            </div>
                        </div>

                        <!-- Memory Card -->
                        <div class="bento-card">
                            <div class="card-label">
                                Memory Usage
                                <div class="card-icon-small" style="background: #FEF3C7; color: #D97706;">üíæ</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 20px; margin-top: 12px;">
                                ${createProgressRing(system.memory.percent)}
                                <div>
                                    <div class="metric-big" style="font-size: 28px;">${formatBytes(system.memory.used)}</div>
                                    <div style="color: var(--text-secondary); font-size: 13px;">of ${formatBytes(system.memory.total)}</div>
                                </div>
                            </div>
                            <div style="margin-top: 12px;">
                                <div class="progress-bar-container">
                                    <div class="progress-bar-fill memory" style="width: ${system.memory.percent}%;"></div>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-top: 6px; font-size: 12px; color: var(--text-secondary);">
                                    <span>${formatBytes(system.memory.free)} free</span>
                                    <span>${system.memory.percent}% used</span>
                                </div>
                            </div>
                        </div>

                        <!-- Uptime Card -->
                        <div class="bento-card card-uptime">
                            <div class="card-label">
                                System Uptime
                                <div class="card-icon-small">üïê</div>
                            </div>
                            <div class="metric-big" style="font-size: 32px; margin-top: 12px;">${system.uptime}</div>
                            <div style="margin-top: auto; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 12px; opacity: 0.7;">
                                ${services.filter(s => s.status === 'running').length} of ${services.length} services running
                            </div>
                        </div>
                    </div>

                    <!-- Services Section -->
                    <h2 style="margin-top: 32px; margin-bottom: 20px; font-size: 20px; font-weight: 500;">Service Metrics</h2>
                    <div class="metrics-grid">
                        ${services.map(service => `
                            <div class="bento-card service-card">
                                <div class="service-header">
                                    <div class="service-name">
                                        <span class="status-dot" style="background: ${getStatusColor(service.status)};"></span>
                                        ${service.name}
                                    </div>
                                    <span style="font-size: 12px; color: var(--text-secondary);">${service.status}</span>
                                </div>

                                ${service.status === 'running' ? `
                                    ${service.domain ? `
                                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">
                                            üåê ${service.domain}
                                        </div>
                                    ` : ''}
                                    <div class="service-metrics">
                                        <div class="metric-item">
                                            <span class="metric-label">CPU</span>
                                            <span class="metric-value">${service.cpu}%</span>
                                        </div>
                                        <div class="metric-item">
                                            <span class="metric-label">Memory</span>
                                            <span class="metric-value">${service.memory} MB</span>
                                        </div>
                                        <div class="metric-item">
                                            <span class="metric-label">Uptime</span>
                                            <span class="metric-value small">${service.uptime}</span>
                                        </div>
                                        ${service.domain ? `
                                            <div class="metric-item">
                                                <span class="metric-label">Requests</span>
                                                <span class="metric-value" style="color: var(--accent-purple);">${service.requestsPerSec || 0} /s</span>
                                            </div>
                                        ` : `
                                            <div class="metric-item">
                                                <span class="metric-label">PID</span>
                                                <span class="metric-value small">${service.pid || '-'}</span>
                                            </div>
                                        `}
                                    </div>
                                    ${service.domain && service.requestsTotal ? `
                                        <div style="margin-top: 8px; font-size: 11px; color: var(--text-secondary);">
                                            ${service.requestsTotal.toLocaleString()} total requests
                                        </div>
                                    ` : ''}
                                    <div style="margin-top: 8px;">
                                        <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">
                                            <span>Memory</span>
                                            <span>${service.memoryPercent}%</span>
                                        </div>
                                        <div class="progress-bar-container">
                                            <div class="progress-bar-fill memory" style="width: ${Math.min(100, service.memoryPercent * 10)}%;"></div>
                                        </div>
                                    </div>
                                ` : `
                                    <div style="color: var(--text-secondary); font-size: 14px; padding: 20px 0; text-align: center;">
                                        Service is ${service.status}
                                    </div>
                                `}
                            </div>
                        `).join('')}
                    </div>
                `;

            } catch (error) {
                const container = document.getElementById('metrics-content');
                container.innerHTML = `
                    <div class="bento-card" style="background: var(--error-bg); border: 1px solid #FECACA;">
                        <p style="color: var(--error-text);">‚ùå Failed to load metrics: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            loadMetrics();
            // Refresh every 2 seconds
            metricsInterval = setInterval(loadMetrics, 2000);
        });

        // Clean up on page leave
        window.addEventListener('beforeunload', () => {
            if (metricsInterval) clearInterval(metricsInterval);
        });
    </script>
</body>

</html>